<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Semicolon | video request</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    />
  </head>
  <body>
    <div class="container my-5">
      <div class="formContainer my-5">
        <!-- <form action="http://localhost:7777/video-request" method="POST"> -->
        <form id="formVideoRequest">
          <div class="row">
            <div class="col-md">
              <div class="form-group">
                <label for="author_name">Your name *</label>
                <input
                  class="form-control"
                  name="author_name"
                  placeholder="Write your name here"
                />
              </div>
            </div>
            <div class="col-md">
              <div class="form-group">
                <label for="author_email">Your email *</label>
                <input
                  class="form-control"
                  name="author_email"
                  placeholder="Write your email here"
                />
              </div>
            </div>
          </div>
          <hr />
          <div class="row">
            <div class="col-md">
              <div class="form-group">
                <label for="topic_title">Topic *</label>
                <input
                  class="form-control"
                  name="topic_title"
                  placeholder="Write your suggested topic here"
                />
              </div>
            </div>
            <div class="col-md">
              <div class="form-group">
                <label for="target_level">Target level</label>
                <select
                  class="form-control"
                  name="target_level"
                  placeholder="Write your name here"
                >
                  <option value="begineer">Beginner</option>
                  <option value="medium">Medium</option>
                  <option value="advanced">Advanced</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md">
              <div class="form-group">
                <label for="topic_details">More details *</label>
                <textarea
                  class="form-control"
                  name="topic_details"
                  placeholder="Write your topic in more details here"
                ></textarea>
              </div>
            </div>
            <div class="col-md">
              <div class="form-group">
                <label for="expected_result">Expected results</label>
                <textarea
                  class="form-control"
                  name="expected_result"
                  placeholder="Write what do you expect after watching this video"
                ></textarea>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-success mt-3">
            Send video request
          </button>
        </form>
      </div>
      <hr />
      <div
        class="btn-group"
        id="sorting_options"
        role="group"
        aria-label="Basic example"
      >
        <button
          type="button"
          id="sort_new"
          class="btn btn-primary"
          onclick="sortVideoRequests('new')"
        >
          New
        </button>
        <button
          type="button"
          id="sort_top_voted"
          class="btn btn-outline-primary"
          onclick="sortVideoRequests('top_voted')"
        >
          Top Voted
        </button>
        <!-- <button type="button" class="btn btn-primary">Right</button> -->
      </div>
      <h1 class="mb-4">List of requested videos</h1>
      <div id="listOfRequests"></div>
    </div>
    <script>
      let videoRequests = [];
      function manipulateApiData(url, method, data) {
        return fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
          // body: data,
        })
          .then((response) => response.json())

          .catch((error) => {
            console.error("Error:", error);
          });
      }
      function addVote(id, vote_type) {
        let data = { id, vote_type };
        manipulateApiData(
          "http://localhost:7777/video-request/vote",
          "put",
          data
        ).then((res) => {
          const voteScore = document.getElementById(`votes_score_${id}`);
          voteScore.innerHTML = formatVoteScore(res);
        });
      }
      function getVideoRequests() {
        manipulateApiData("http://localhost:7777/video-request", "get").then(
          (res) => {
            videoRequests = res;
            showVideoRequest(res);
          }
        );
      }
      function formatVideoReq(req) {
        return `<div class="card mb-3">
          <div class="card-body d-flex justify-content-between flex-row">
            <div class="d-flex flex-column">
              <h3>${req.topic_title}</h3>
              <p class="text-muted mb-2">${req.topic_details}</p>
              <p class="mb-0 text-muted">
                ${
                  req.expected_result &&
                  `<strong>Expected results:</strong> ${req.expected_result}`
                }
              </p>
            </div>
            <div class="d-flex flex-column text-center">
              <a class="btn btn-link" onclick="addVote('${
                req._id
              }', 'ups')">ðŸ”º</a>
              <h3 id="votes_score_${req._id}">${formatVoteScore(req.votes)}</h3>
              <a class="btn btn-link" onclick="addVote('${
                req._id
              }', 'downs')">ðŸ”»</a>
            </div>
          </div>
          <div class="card-footer d-flex flex-row justify-content-between">
            <div>
              <span class="text-info">${req.status}</span>
              &bullet; added by <strong>${req.author_name}</strong> on
              <strong>${new Date(req.submit_date).toLocaleString()}</strong>
            </div>
            <div
              class="d-flex justify-content-center flex-column 408ml-auto mr-2"
            >
              <div class="badge badge-success">${req.target_level}</div>
            </div>
          </div>
        </div>`;
      }
      function formatVoteScore({ ups, downs }) {
        return ups - downs;
      }
      // DOMContentLoaded => fired when elements is loaded not images or styles
      // window.onload() =>fired when everything is loaded incuded images and styles
      function sortVideoRequests(type) {
        let otherType = type === "new" ? "top_voted" : "new";
        let typeButton = document.getElementById(`sort_${type}`);
        let otherTypedButton = document.getElementById(`sort_${otherType}`);
        typeButton.classList.remove("btn-outline-primary");
        typeButton.classList.add("btn-primary");
        otherTypedButton.classList.add("btn-outline-primary");
        otherTypedButton.classList.remove("btn-primary");
        let sortedArray = [];
        if (type == "new") {
          sortedArray = videoRequests.sort(
            (a, b) => a.submit_date < b.submit_date
          );
        } else {
          sortedArray = videoRequests.sort(
            (a, b) => formatVoteScore(a.votes) < formatVoteScore(b.votes)
          );
        }
        showVideoRequest(sortedArray);
      }
      function showVideoRequest(videoRequests) {
        const videoReqList = document.getElementById("listOfRequests");
        videoReqList.innerHTML = "";
        videoRequests.forEach((req) => {
          let videoReq = document.createElement("div");
          videoReq.innerHTML = formatVideoReq(req);
          videoReqList.append(videoReq);
        });
      }
      document.addEventListener("DOMContentLoaded", function () {
        const videoReqList = document.getElementById("listOfRequests");
        const formVidReq = document.getElementById("formVideoRequest");
        getVideoRequests();
        formVidReq.addEventListener("submit", (event) => {
          event.preventDefault();
          const elements = document.querySelectorAll(
            "#formVideoRequest .form-control"
          );

          // let formData = new FormData(formVidReq);
          let data = {};
          elements.forEach((element) => {
            data[element.name] = element.value;
          });
          // console.log(data);
          manipulateApiData(
            "http://localhost:7777/video-request",
            "post",
            data
          ).then((res) => {
            let videoReq = document.createElement("div");
            videoReq.innerHTML = formatVideoReq(res);
            videoReqList.append(videoReq);
            videoRequests.push(res);
          });
        });
      });
    </script>
  </body>
</html>
